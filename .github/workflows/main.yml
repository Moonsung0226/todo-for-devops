name: üöÄ Deploy to Azure App Service (Docker Hub)

on:
  push:
    branches: main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout source
        uses: actions/checkout@v3

      - name: üê≥ Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: üèó Build and push Docker image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/todo-next-app:latest .
          docker push ${{ secrets.DOCKER_USERNAME }}/todo-next-app:latest
# Î∞∞Ìè¨
      - name: üîê Azure CLI login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: üõ† Create Web App (if not exists)
        run: |
          WEBAPP_NAME=todo-webapp-dev-${{ github.run_id }}

          if ! az webapp show --name $WEBAPP_NAME --resource-group rg-appservice-infrastructure-dev-04 &> /dev/null; then
            az webapp create \
              --resource-group rg-appservice-infrastructure-dev-04 \
              --plan asp-dev \
              --name $WEBAPP_NAME

            az webapp config container set \
              --name $WEBAPP_NAME \
              --resource-group rg-appservice-infrastructure-dev-04 \
              --docker-custom-image-name ${{ secrets.DOCKER_USERNAME }}/todo-app \
              --docker-registry-server-url https://index.docker.io
          fi
      

      - name: ‚öôÔ∏è Set App Service port setting
        run: |
          az webapp config appsettings set \
            --name todo-webapp-dev \
            --resource-group rg-appservice-infrastructure-dev-04 \
            --settings WEBSITES_PORT=3000

      - name: üöÄ Configure App Service to use Docker Hub
        run: |
          az webapp config container set \
            --name todo-webapp-dev \
            --resource-group rg-appservice-infrastructure-dev-04 \
            --container-image-name ${{ secrets.DOCKER_USERNAME }}/todo-app \
            --container-registry-url https://index.docker.io

      - name: üîÅ Restart App Service
        run: |
          az webapp restart \
            --name todo-webapp-dev \
            --resource-group rg-appservice-infrastructure-dev-04